"""
Session reschedule prediction model representing ML predictions for upcoming sessions.
"""
from typing import TYPE_CHECKING
from datetime import datetime
from sqlalchemy import Column, String, DateTime, ForeignKey, Numeric, Index
from sqlalchemy.dialects.postgresql import UUID, JSON
from sqlalchemy.orm import relationship

from app.models.base import BaseModel

if TYPE_CHECKING:
    from app.models.session import Session


class SessionReschedulePrediction(BaseModel):
    """
    Session reschedule prediction model representing ML predictions for upcoming sessions.
    
    Relationships:
    - session: One-to-one relationship with Session model
    
    This model stores predictions generated by the ML model for each upcoming session,
    including the probability of reschedule and risk level classification.
    """
    __tablename__ = 'session_reschedule_predictions'
    
    session_id = Column(UUID(as_uuid=True), ForeignKey('sessions.id'), unique=True, nullable=False)
    reschedule_probability = Column(Numeric(5, 4), nullable=False)  # 0.0000 to 1.0000
    risk_level = Column(String(20), nullable=False)  # 'low', 'medium', 'high'
    model_version = Column(String(20), nullable=False, default='v1.0')
    predicted_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    features_json = Column(JSON, nullable=True)  # Store feature values for debugging
    
    # Relationships
    session = relationship('Session', back_populates='session_reschedule_prediction')
    
    # Indexes
    __table_args__ = (
        Index('ix_session_reschedule_predictions_session_id', 'session_id'),
        Index('ix_session_reschedule_predictions_risk_level', 'risk_level'),
        Index('ix_session_reschedule_predictions_predicted_at', 'predicted_at'),
        Index('ix_session_reschedule_predictions_session_risk', 'session_id', 'risk_level'),
    )
    
    def __repr__(self) -> str:
        return f"<SessionReschedulePrediction(id={self.id}, session_id={self.session_id}, risk_level='{self.risk_level}', probability={self.reschedule_probability})>"

